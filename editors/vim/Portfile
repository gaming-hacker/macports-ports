# -*- coding: utf-8; mode: _tcl; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -\*- vim:fenc=utf-8:ft=tcl:et:sw=2:ts=2:sts=2

PortSystem	1.0
PortGroup           github 1.0

name                vim
set vim_version     8.1
set vim_patchlevel  0280
github.setup        vim vim ${vim_version}.${vim_patchlevel} v
revision            1
categories          editors
platforms           darwin freebsd
license             Vim GPL-2+
maintainers         {raimue @raimue}

description         Vi \"workalike\" with many additional features
long_description \
    Vim is an advanced text editor that seeks to provide the power of the   \
    de-facto Unix editor 'Vi', with a more complete feature set.

homepage            http://www.vim.org/

checksums           rmd160  66e1101f20368d60bf37c438f84a6b6d319fa2c1 \
sha256  fe1d620e4a4663a35c9401b9a3ff4d958415ee3c2bcba9a10d95d3fb0b6f7188 \
size    13783224

depends_lib         port:ncurses \
                    port:gettext \
                    port:libiconv

# fix test macro for sdk check
patchfiles-append   patch-vim-src-os_macosx-availability.diff

post-patch {
    set features [open ${worksrcpath}/src/feature.h a+]
    puts $features "#define SYS_VIMRC_FILE \"${prefix}/etc/vimrc\""
    close $features
}

autoconf.cmd make autoconf
autoconf.pre_args
autoconf.args
autoconf.dir ${worksrcpath}/src

configure.args      --disable-gui \
                    --without-x \
                    --without-local-dir \
                    --disable-gpm \
                    --mandir=${prefix}/share/man \
                    --with-tlib=ncurses \
                    --enable-multibyte \
                    --with-developer-dir=${developer_dir} \
                    --enable-fail-if-missing \
                    --with-compiledby="Alexander"

post-destroot {
    ln -s ${prefix}/bin/vim ${destroot}${prefix}/bin/vi
}

test.run            yes

if {![variant_isset tiny] && ![variant_isset small] && ![variant_isset big] && ![variant_isset huge]} {
    default_variants +huge
}

variant x11 description {Build CLI version with X support} {
    configure.args-delete   --without-x
    configure.args-append   --with-x --x-includes=${prefix}/include --x-libraries=${prefix}/lib
    depends_lib-append      port:xorg-libXt
}


variant gtk3 description {Build GUI version using GTK 3.x widgets} requires x11 conflicts athena gtk2 motif {
    configure.args-delete   --disable-gui
    configure.args-append   --enable-gui=gtk3 --disable-darwin
    depends_lib-append      port:gtk3
}

configure.args-append --with-features=normal
set levels {tiny small big huge}
foreach level ${levels} {
    variant ${level} description "Build ${level} feature set" conflicts {*}[lsearch -inline -all -not -exact $levels $level] {
        configure.args-replace --with-features=normal --with-features=$level
    }
}

variant xim description {Build with support for X Input Method} {
    configure.args-append --enable-xim
}

variant perl description {Enable Perl scripting} {
    configure.args-append   --enable-perlinterp
    depends_lib-append      path:bin/perl:perl5.26
}

variant python37 description {Enable Python scripting} {
    configure.args-append   --enable-pythoninterp --with-python-command=${prefix}/bin/python3.7
    patchfiles-append       patch-python.diff
    depends_lib-append      port:python37

    use_autoconf yes
    # Overwriting autoconf.cmd above removes dependency, add it again
    depends_build-append port:autoconf
}
variant python36 conflicts python37 description {Enable Python scripting} {
    configure.args-append   --enable-python3interp --with-python3-command=${prefix}/bin/python3.6
    patchfiles-append       patch-python3.diff
    depends_lib-append      port:python36

    use_autoconf yes
    # Overwriting autoconf.cmd above removes dependency, add it again
    depends_build-append port:autoconf
}
variant python37 conflicts python36 description {Enable Python scripting} {
    configure.args-append   --enable-python3interp --with-python3-command=${prefix}/bin/python3.7
    patchfiles-append       patch-python3.diff
    depends_lib-append      port:python37

    use_autoconf yes
    # Overwriting autoconf.cmd above removes dependency, add it again
    depends_build-append port:autoconf
}

variant ruby25 conflicts ruby18 ruby19 ruby20 ruby21 ruby22 ruby23 ruby24 description {Enable Ruby scripting} {
    configure.args-append   --enable-rubyinterp
    configure.args-append   --with-ruby-command=${prefix}/bin/ruby2.5
    depends_lib-append      port:ruby25
}

variant tcl description {Enable Tcl scripting} {
    configure.args-append   --enable-tclinterp \
                            --with-tclsh=${prefix}/bin/tclsh
    patchfiles-append       patch-tcl.diff
    depends_lib-append      port:tcl

    use_autoconf yes
    # Overwriting autoconf.cmd above removes dependency, add it again
    depends_build-append port:autoconf
}

variant lua description {Enable Lua scripting} {
    configure.args-append   --enable-luainterp \
                            --with-lua-prefix=${prefix}
    depends_lib-append      port:lua
}

variant cscope description {Enable source code browsing with cscope} {
    configure.args-append   --enable-cscope
}

platform puredarwin {
    configure.args-append --disable-darwin
}
