# -*- coding: utf-8; mode: _tcl; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- vim:fenc=utf-8:ft=tcl:et:sw=2:ts=2:sts=2

PortSystem                  1.0
PortGroup                   conflicts_build 1.0
PortGroup user 1.0
# Keep relevant lines in sync between ImageMagick and p5-perlmagick.

# Before updating to a newer version, install phpNN-imagick. After updating, run `phpNN -v`. If the following warning appears, revbump php-imagick.
# PHP Warning:  Version warning: Imagick was compiled against Image Magick version XXXX but version YYYY is loaded. Imagick will run but may behave surprisingly in Unknown on line 0

name                        ImageMagick
version                     7.0.7-32
revision 0
set reasonable_version      [lindex [split ${version} -] 0]
homepage                    http://www.imagemagick.org/
categories                  graphics devel
maintainers                 {ryandesign @ryandesign}
license                     Apache-2
use_xz                      yes
platforms                   darwin
use_parallel_build          yes

description                 Tools and libraries to manipulate images in many formats

long_description            ImageMagick is a robust collection of tools and \
                            libraries to create, edit and compose bitmap images \
                            in a wide variety of formats. You can crop, resize, \
                            rotate, sharpen, color reduce or add effects or text \
                            or straight or curved lines to an image or image \
                            sequence and save your completed work in the same or \
                            differing image format. You can even create images \
                            from scratch. Image processing operations are \
                            available from the command line as well as through \
                            C, Ch, C++, Java, Perl, PHP, Python, Ruby and Tcl/Tk \
                            programming interfaces. Over 90 image formats are \
                            supported, including GIF, JPEG, JPEG 2000, PNG, PDF, \
                            PhotoCD and TIFF.

master_sites  http://www.imagemagick.org/download/ \
              http://mirror.checkdomain.de/imagemagick/ \                      ftp://ftp.u-aizu.ac.jp/pub/graphics/image/ImageMagick/imagemagick.org/ \
ftp://ftp.sunet.se/pub/multimedia/graphics/ImageMagick \
ftp://sunsite.icm.edu.pl/packages/ImageMagick

checksums rmd160  2cd547ab2c5d0ad45aca6d77ff652d1c3336f005 \
sha256  6267b33cfba2caae0e72e91548f2e0a3030861acb337d39e5344a0d8dd991152 \
size    8609452

depends_lib   port:bzip2 \
              port:djvulibre \
              port:xz \
              port:jbigkit \
              port:jpeg \
              port:lcms2 \
              port:libpng \
              port:libraw \
              port:tiff \
              port:webp \
              port:zlib \
              port:fftw-3 \
              port:freetype \
              port:fontconfig \
              port:ghostscript \
              port:libiconv \
              port:libtool \
              port:openjpeg \
              port:openexr \
              port:expat \
              port:libxml2 \
              port:liblqr \
              port:libwmf

# Magick-config etc. use pkg-config
depends_lib-append          port:pkgconfig

depends_run                 port:urw-fonts

# On case-insensitive filesystems, ImageMagick finds cryptlib's libcl and
# tries to use it as if it were Apple's OpenCL, which fails; see #23354.
if {[file exists ${prefix}/lib/libCL.dylib]} {
    conflicts_build         cryptlib
}

use_autoreconf  yes

configure.args  --enable-shared \
      --enable-static \
      --disable-ltdl-install \
      --disable-silent-rules \
      --disable-rpath --disable-nls \
      --disable-assert \
      --with-frozenpaths \
      --with-openexr \
      --enable-hdri \
      --without-dps \
      --with-bzlib \
      --with-djvu \
      --with-fontconfig \
      --with-gslib \
      --with-jbig \
      --with-jpeg \
      --with-lcms \
      --with-openjp2 \
      --with-png \
      --with-tiff \
      --with-webp \
      --with-zlib \
      --with-fftw \
      --without-heic \
      --without-modules \
      --with-xml \
      --without-perl \
      --without-fpx \
      --without-wmf \
      --without-gvc \
      --with-rsvg \
      --with-lqr \
      --without-x \
      --with-quantum-depth=64 \
      --disable-deprecated \
      --enable-hugepages \
      --enable-openmp \
      --enable-opencl \
      --enable-zero-configuration \
      --with-gcc-arch=native \
      --with-apple-font-dir=/Library/Fonts \
      --with-gs-font-dir=${prefix}/share/fonts/urw-fonts \
      --disable-docs \
      --disable-cipher \
      --without-autotrace \
      --disable-option-checking \
      --disable-maintainer-mode \
      --enable-fast-install \                        --with-sysroot=${prefix}/libexec/llvm-${user.ver.clang}/c++/v1

# On case-insensitive filesystems, ImageMagick finds cryptlib's libcl and
# tries to use it as if it were Apple's OpenCL, which fails; see #23354.
if {[file exists ${prefix}/lib/libCL.dylib]} {
    conflicts_build         cryptlib
}

test.run                    yes
test.target                 check
test.env                    DYLD_LIBRARY_PATH=${worksrcpath}/magick/.libs

# ImageMagick uses .la files at runtime to find its coder modules.
destroot.delete_la_files    no

variant graphviz description {Support Graphviz} {
    depends_lib-append      path:bin/dot:graphviz-devel
    configure.args-replace  --without-gvc --with-gvc
}

variant pango description {Support Pango} {
    depends_lib-append      path:lib/pkgconfig/pango.pc:pango
    configure.args-replace  --without-pango --with-pango
}

variant x11 {
    depends_lib-append      port:xorg-libX11 \
                            port:xorg-libXext \
                            port:xorg-libXt
    configure.args-replace  --without-x --with-x
}

# default_variants            +x11 +lqr +wmf +rsvg
default_variants            -x11

livecheck.version           ${reasonable_version}
livecheck.type              regex
livecheck.url               [lindex ${master_sites} 0]
livecheck.regex             ${name}-(7(?:\\.\\d+)*)(?:-\\d+)?
