# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:filetype=tcl:et:sw=4:ts=4:sts=4

PortSystem      1.0
PortGroup       github 1.0
# PortGroup       perl 5.26

set short_name      flif
name                lib${short_name}
version             0.3.0
revision            0
categories          image web
license             LGPLv3+
platforms           darwin
supported_archs     x86_64

github.author       gaming-hacker
maintainers         github:${github.author}
github.tag_prefix   v1

description         Free Lossless Image Format
long_description    FLIF is a lossless image format based \
                    on MANIAC compression. MANIAC (Meta-Adaptive Near-zero \
                    Integer Arithmetic Coding) is a variant of CABAC \
                    (context-adaptive binary arithmetic coding), where \
                    the contexts are nodes of decision trees which are \
                    dynamically learned at encode time. \
                    \
                    FLIF outperforms PNG, FFV1, lossless WebP, lossless \
                    BPG and lossless JPEG2000 in terms of compression ratio. \

fetch.type          git

git.branch          origin/${github.tag_prefix}

git.url             https://github.com/${github.author}/${short_name}

github.homepage     https://github.com/${github.author}/${short_name}

github.master_sites https://github.com/${github.author}/${short_name}

configure.compiler  macports-clang-5.0

configure.ccache    no

use_configure       no

use_autoreconf      no

set FLAGS "-O3 -pipe -m64 -arch x86_64 -fopenmp -march=native -mtune=native -mmacosx-version-min=10.12 -fomit-frame-pointer -fno-common -mavx -mavx2 -mfma -mfpmath=sse -msse2 -msse3 -msse4.1 -msse4.2"

set WNO "-Wno-unknown-warning-option -Wno-unused-function -Wno-unused-variable -Wno-unused-command-line-argument -Wno-ignored-optimization-argument"

set MACROS "-DLEVEL1_DCACHE_LINESIZE=64 -DLEVEL1_DCACHE_SIZE=32 -DLEVEL2_DCACHE_SIZE=256 -DHASWELL -DL1_DATA_SIZE=32768 -DL1_DATA_LINESIZE=64 -DL2_SIZE=262144 -DL2_LINESIZE=64 -DDTB_DEFAULT_ENTRIES=64 -DDTB_SIZE=4096 -DHAVE_AVX -DHAVE_AVX2 -DHAVE_CFLUSH -DHAVE_CMOV -DHAVE_FMA3 -DHAVE_MMX -DHAVE_PSE -DHAVE_SSE -DHAVE_SSE2 -DHAVE_SSE3 -DHAVE_SSSE3 -DSSE4_1 -DHAVE_SSE4_2 -DHAVE_VFPV3 -DHAVE_OPENCL -D_REENTRANT -D_THREAD_SAFE -D_LARGEFILE64_SOURCE -D_FILE_OFFSET_BITS=64 -DHAVE_NASM -DNDEBUG -DPIC -DUSE_PTHREAD"

configure.cc        ${prefix}/bin/clang-mp-5.0

configure.cflags    ${FLAGS} ${WNO} ${MACROS} -std=c11 -stdlib=libc++

configure.cxx       ${prefix}/bin/clang++-mp-5.0

configure.cxxflags  ${FLAGS} ${WNO} ${MACROS} -std=c++14 -stdlib=libc++

configure.cpp       ${prefix}/bin/clang-cpp-mp-5.0

configure.env       CC=${configure.cc} CFLAGS=${configure.cflags}

build.cmd               ${prefix}/bin/gmake
build.env               MAKE=${prefix}/bin/gmake
# build.args              CC=${configure.cc} CFLAGS=${configure.cflags}

depends_lib     port:libpng \
                port:libsdl2 \
                port:gdk-pixbuf2 \
                port:zimg \
                port:exif \
                port:libexif \
                port:p5.26-image-exiftool \
                port:gmake

depends_build-append          port:pkgconfig

livecheck.type      none
