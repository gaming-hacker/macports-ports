# -*- coding: utf-8; mode: _tcl; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- vim:fenc=utf-8:ft=tcl:et:sw=2:ts=2:sts=2

PortSystem          1.0
<<<<<<< HEAD
PortGroup           qt5 1.0
=======
PortGroup           cxx11 1.1
>>>>>>> 5dd6f69b0aca6f7d3bd0f765f7f220c4c16fe107

name                psi
version             1.4
categories          net chat
maintainers         {rowue @rowue}
description         jabber-based instant messaging client
long_description \
    Psi is a capable Jabber client aimed at experienced users.  Its design \
    goals are simplicity and stability.
license             GPL-2+

platforms           darwin

homepage            https://psi-im.org/
master_sites        sourceforge
use_xz              yes

<<<<<<< HEAD
checksums           md5     9d7dcce3bcab53b741a712199bd986be \
sha1    f5f8e1a427339a4e9113b5fa513b01a42ae1be4b \
rmd160  0c4a07726c2f9819da0f8aa8f1982e939f1fc20f
=======
checksums           rmd160  2f047baa0e2af16c949f6bb33667124253e231e4 \
                    sha256  761934c1c62daf69215f085ba24d7f9cd4db05ef0ad735383d68fb03d21571ad \
                    size    2119840
>>>>>>> 5dd6f69b0aca6f7d3bd0f765f7f220c4c16fe107

configure.args      --bindir=${applications_dir} \
                    --disable-growl \
                    --disable-xss \
                    --enable-webkit

pre-configure {
    configure.args-append \
                    --qtdir=${qt_dir}
}

patchfiles-append    patch-qt4-compat.diff

depends_lib-append   port:libidn \
                     port:minizip \
                     port:zlib

post-destroot {
    # install themes (see end of src/src.pro)
    copy ${worksrcpath}/themes ${destroot}${applications_dir}/psi.app/Contents/Resources
}

# Currently, the qconf build system does not work well the the MacPorts system.
# For now, use the extraconf configure argument for bare minimum configuration.
# Further research is required.
universal_variant    no

variant qt4 conflicts qt5 description "build Qt4 version of ${name}" {
    PortGroup qt4 1.0

    depends_lib-append \
                    port:qca

    pre-configure {
        # port requires C++11 compiler
        set extra_conf "
            QMAKE_CXX=${configure.cxx}
        "
        configure.args-append --extraconf="[join ${extra_conf} \n]"
    }
}

<<<<<<< HEAD
# variant ipv6 description {Add ipv6 support} {
#
# patchfiles-append      patch-src-src.pro.diff
# }

variant plugins description {Build with experimental Plugin Support} {

patch.pre_args          -p1

patchfiles-append       patch-configure.diff \
                        patch-src-applicationinfo.cpp.diff \
                        patch-src-pluginhost.cpp.diff \
                        patch-src-pluginhost.h.diff \
                        patch-src-pluginmanager.cpp.diff \
                        patch-src-pluginmanager.h.diff \
                        patch-src-plugins-include-eventfilter.h.diff \
                        patch-src-plugins-include-iqfilter.h.diff \
                        patch-src-plugins-include-psiplugin.h.diff \
                        patch-src-plugins-include-stanzasender.h.diff \
                        patch-src-psiaccount.cpp.diff \
                        patch-src-psichatdlg.cpp.diff \
                        patch-src-psichatdlg.h.diff \
                        patch-src-src.pro.diff

configure.args-append   --enable-plugins
=======
variant qt5 conflicts qt4 description "build Qt5 version of ${name}" {
    PortGroup qt5 1.0

    depends_lib-append \
                    port:qca-qt5

    qt5.depends_component \
                    qtmultimedia \
                    qtwebengine

    pre-configure {
    # avoid crash at startup (allow psi to look for MacPorts Qt plugins)
        set extra_conf "
        QMAKE_CXXFLAGS+=-DALLOW_QT_PLUGINS_DIR
    "
        configure.args-append --extraconf="[join ${extra_conf} \n]"
    }
}

# somewhat arbitrary boundary for Qt versions
if { ![variant_isset qt4] && ![variant_isset qt5] } {
    if {${os.major} >= 14} {
        default_variants-append +qt5
    } else {
        default_variants-append +qt4
    }
>>>>>>> 5dd6f69b0aca6f7d3bd0f765f7f220c4c16fe107
}
