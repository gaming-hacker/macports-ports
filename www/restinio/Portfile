# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
PortSystem                  1.0
PortGroup                   github 1.0
PortGroup                   cmake 1.1
PortGroup                   compiler_blacklist_versions 1.0

github.setup                Stiffstream restinio 0.4.5 v.
categories                  www devel
platforms                   darwin
license                     BSD
maintainers                 @Lord-Kamina
description                 Header-only C++14 library that gives you an embedded HTTP/Websocket server.
depends_build-append        port:boost port:openssl port:pcre port:zlib bin:doxygen:doxygen
depends_lib-append          port:asio \
                            port:http-parser \
                            path:include/fmt/format.h:libfmt \
                            path:include/fmt/ostream.h:libfmt \
                            path:include/fmt/time.h:libfmt
long_description            RESTinio is a header-only C++14 library that gives you an embedded \
                            HTTP/Websocket server. It is based on standalone version of ASIO and targeted \
                            primarily for asynchronous processing of HTTP-requests.
checksums                   rmd160  89e93f388e26ae02c4e0d36130668fe493591995 \
                            sha256  8c180348fb9fa90688b1c67351d336c6627b0d1ab8ab084d00658a44a280031a
homepage                    https://stiffstream.com/en/products/restinio.html

patchfiles                  patch-CMakeLists.txt.diff \
                            patch-Doxyfile.diff

cmake.source_dir            ${worksrcpath}/dev
cmake.build_type            Release

configure.env-append        ASIO_STANDALONE=1 \
                            ASIO_HAS_STD_CHRONO=1 \
                            ASIO_DISABLE_STD_STRING_VIEW=1 \
                            FMT_HEADER_ONLY=1 \
                            RAPIDJSON_HAS_STDSTRING=1 \
                            RAPIDJSON_HAS_CXX11_RVALUE_REFS=1
configure.pre_args-delete   -DCMAKE_POLICY_DEFAULT_CMP0025=NEW
configure.optflags-delete   -Os
cmake.generator             Unix Makefiles
compiler.blacklist          *gcc-3.* *gcc-4.* {*gcc-5.[0-3]} \
                            {clang < 800} macports-clang-3.4 macports-clang-3.5 macports-clang-3.6 macports-clang-3.7

destroot {
    set components { . impl path2regex router third_party/optional-lite third_party/string-view-lite transforms utils utils/impl websocket websocket/impl }
    set files { }
    set instdir "${destroot}${prefix}/include/${github.project}"

    foreach i ${components} {
        lappend files {*}[glob -tails -directory ${worksrcpath}/dev/${github.project}/ ${i}/*{.hpp,.inl}]
        xinstall -m 755 -d ${instdir}/${i}
    }
    foreach x ${files} {
        xinstall -m 644 "${worksrcpath}/dev/${github.project}/${x}" "${instdir}/${x}"
    }
    set docdir "${destroot}${prefix}/share/doc/${github.project}"
    xinstall -m 755 -d "${docdir}/html/search"
    system -W ${worksrcpath}/dev "${prefix}/bin/doxygen ${worksrcpath}/dev/Doxyfile"
    xinstall -m 644 "${worksrcpath}/README.md" "${docdir}"
    xinstall -m 644 "${worksrcpath}/LICENSE" "${docdir}"
    xinstall -m 644 {*}[glob "${worksrcpath}/dev/doc/html/*.*" "${docdir}/html"]
    xinstall -m 644 {*}[glob "${worksrcpath}/dev/doc/html/search/*.*" "${docdir}/html/search"]
}

build.post_args-delete      VERBOSE=ON
